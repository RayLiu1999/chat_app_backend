# Docker Compose - 水平擴展測試環境
# 使用方式: docker-compose -f docker-compose.scale.yml up -d --scale app=3

services:
  # nginx 負載均衡器
  nginx:
    image: nginx:alpine
    container_name: chat_nginx_lb
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.scale.conf:/etc/nginx/nginx.conf:ro
      - /dev/null:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app
    networks:
      - chat-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

  # 聊天應用後端服務 - 可擴展
  # 注意：移除了 container_name 以支援 --scale
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    restart: unless-stopped
    # 不暴露固定端口，由 nginx 負載均衡
    expose:
      - "${SERVER_PORT:-80}"
    env_file: 
      - ${ENV_FILE:-.env.development}
    environment:
      DOCKER_ENV: "true"
      ENV: "development"
      GIN_MODE: "debug"
      # 用於識別不同實例
      INSTANCE_ID: "${HOSTNAME:-unknown}"
      # Go Runtime 效能調校參數
      GOMEMLIMIT: "900MiB"
      GOMAXPROCS: "1"
    volumes:
      - .:/app
      - go-modules-scale:/go/pkg/mod:ro
      - /root/.cache/go-build
      - ./uploads:/app/uploads
    networks:
      - chat-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --spider --quiet http://localhost:${SERVER_PORT:-80}/health || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 512M

volumes:
  go-modules-scale:
    driver: local

networks:
  chat-network:
    driver: bridge
